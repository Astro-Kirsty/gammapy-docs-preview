
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Spectral analysis &#8212; gammapy vX.Y.Z</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Spectral analysis with the HLI" href="spectral_analysis_hli.html" />
    <link rel="prev" title="Flux point fitting" href="sed_fitting.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../development/index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        dev  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables tutorials/analysis-1d/spectral_analysis and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': 'dev'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "tutorials/analysis-1d/spectral_analysis.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "tutorials/analysis-1d/spectral_analysis.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.2.dev1721+g6c725d50c variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "dev") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/analysis_1.html">
   High level interface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/analysis_2.html">
   Low level API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/overview.html">
   Data structures
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../data/cta.html">
   CTA with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/fermi_lat.html">
   Fermi-LAT with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/hawc.html">
   HAWC with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/hess.html">
   H.E.S.S. with Gammapy
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="cta_sensitivity.html">
   Point source sensitivity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="extended_source_spectral_analysis.html">
   Spectral analysis of extended sources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sed_fitting.html">
   Flux point fitting
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Spectral analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="spectral_analysis_hli.html">
   Spectral analysis with the HLI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="spectral_analysis_rad_max.html">
   Spectral analysis with energy-dependent directional cuts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="spectrum_simulation.html">
   1D spectrum simulation
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-2d/detect.html">
   Source detection and significance maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-2d/modeling_2D.html">
   2D map fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-2d/ring_background.html">
   Ring background map
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/analysis_3d.html">
   3D detailed analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/analysis_mwl.html">
   Multi instrument joint 3D and 1D analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/cta_data_analysis.html">
   Basic image exploration and fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/event_sampling.html">
   Event sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/event_sampling_nrg_depend_models.html">
   Sample a source with energy-dependent temporal evolution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/flux_profiles.html">
   Flux Profile Estimation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/simulate_3d.html">
   3D map simulation
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-time/Variability_estimation.html">
   Estimation of time variability in a lightcurve
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-time/light_curve.html">
   Light curves
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-time/light_curve_flare.html">
   Light curves for flares
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-time/light_curve_simulation.html">
   Simulating and fitting a time varying source
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-time/pulsar_analysis.html">
   Pulsar analysis
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../api/astro_dark_matter.html">
   Dark matter spatial and spectral models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/catalog.html">
   Source catalogs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/datasets.html">
   Datasets - Reduced data, IRFs, models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/fitting.html">
   Fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/makers.html">
   Makers - Data reduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/maps.html">
   Maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/mask_maps.html">
   Mask maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/model_management.html">
   Modelling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/models.html">
   Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/observation_clustering.html">
   Observational clustering
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../scripts/survey_map.html">
   Survey Map Script
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#context">
   Context
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#check-setup">
   Check setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-target-region">
   Define Target Region
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-exclusion-mask">
   Create exclusion mask
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-data-reduction-chain">
   Run data reduction chain
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plot-off-regions">
   Plot off regions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#source-statistic">
   Source statistic
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-spectrum">
   Fit spectrum
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fit-quality-and-model-residuals">
   Fit quality and model residuals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compute-flux-points">
   Compute Flux Points
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stack-observations">
   Stack observations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercises">
   Exercises
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-next">
   What next?
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-tutorials-analysis-1d-spectral-analysis-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code or to run this example in your browser via Binder</p>
</div>
<section class="sphx-glr-example-title" id="spectral-analysis">
<span id="sphx-glr-tutorials-analysis-1d-spectral-analysis-py"></span><h1>Spectral analysis<a class="headerlink" href="#spectral-analysis" title="Permalink to this headline">#</a></h1>
<p>Perform a full region based on-off spectral analysis and fit the resulting datasets.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Understanding how spectral extraction is performed in Cherenkov
astronomy, in particular regarding OFF background measurements.</p></li>
<li><p>Understanding the basics data reduction and modeling/fitting process
with the gammapy library API as shown in the <a class="reference internal" href="../starting/analysis_2.html"><span class="doc">Low level API</span></a>
tutorial.</p></li>
</ul>
</section>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">#</a></h2>
<p>While 3D analyses allow in principle to consider complex field of views
containing overlapping gamma-ray sources, in many cases we might have an
observation with a single, strong, point-like source in the field of
view. A spectral analysis, in that case, might consider all the events
inside a source (or ON) region and bin them in energy only, obtaining 1D
datasets.</p>
<p>In classical Cherenkov astronomy, the background estimation technique
associated with this method measures the number of events in OFF regions
taken in regions of the field-of-view devoid of gamma-ray emitters,
where the background rate is assumed to be equal to the one in the ON
region.</p>
<p>This allows to use a specific fit statistics for ON-OFF measurements,
the wstat (see <a class="reference internal" href="../../api/gammapy.stats.wstat.html#gammapy.stats.wstat" title="gammapy.stats.wstat"><code class="xref py py-obj docutils literal notranslate"><span class="pre">wstat</span></code></a>), where no background model is
assumed. Background is treated as a set of nuisance parameters. This
removes some systematic effects connected to the choice or the quality
of the background model. But this comes at the expense of larger
statistical uncertainties on the fitted model parameters.</p>
<p><strong>Objective: perform a full region based spectral analysis of 4 Crab
observations of H.E.S.S. data release 1 and fit the resulting
datasets.</strong></p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>Here, as usual, we use the <a class="reference internal" href="../../api/gammapy.data.DataStore.html#gammapy.data.DataStore" title="gammapy.data.DataStore"><code class="xref py py-obj docutils literal notranslate"><span class="pre">DataStore</span></code></a> to retrieve a
list of selected observations (<a class="reference internal" href="../../api/gammapy.data.Observations.html#gammapy.data.Observations" title="gammapy.data.Observations"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Observations</span></code></a>). Then, we
define the ON region containing the source and the geometry of the
<a class="reference internal" href="../../api/gammapy.datasets.SpectrumDataset.html#gammapy.datasets.SpectrumDataset" title="gammapy.datasets.SpectrumDataset"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SpectrumDataset</span></code></a> object we want to produce. We then
create the corresponding dataset Maker.</p>
<p>We have to define the Maker object that will extract the OFF counts from
reflected regions in the field-of-view. To ensure we use data in an
energy range where the quality of the IRFs is good enough we also create
a safe range Maker.</p>
<p>We can then proceed with data reduction with a loop over all selected
observations to produce datasets in the relevant geometry.</p>
<p>We can then explore the resulting datasets and look at the cumulative
signal and significance of our source. We finally proceed with model
fitting.</p>
<p>In practice, we have to:</p>
<ul class="simple">
<li><p>Create a <a class="reference internal" href="../../api/gammapy.data.DataStore.html#gammapy.data.DataStore" title="gammapy.data.DataStore"><code class="xref py py-obj docutils literal notranslate"><span class="pre">DataStore</span></code></a> pointing to the relevant data</p></li>
<li><p>Apply an observation selection to produce a list of observations,
a <a class="reference internal" href="../../api/gammapy.data.Observations.html#gammapy.data.Observations" title="gammapy.data.Observations"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Observations</span></code></a> object.</p></li>
<li><p>Define a geometry of the spectrum we want to produce:</p>
<ul>
<li><p>Create a <a class="reference external" href="https://astropy-regions.readthedocs.io/en/latest/api/regions.CircleSkyRegion.html#regions.CircleSkyRegion" title="(in regions v0.9.dev12+g90c44ad)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">CircleSkyRegion</span></code></a> for the ON extraction region</p></li>
<li><p>Create a <a class="reference internal" href="../../api/gammapy.maps.MapAxis.html#gammapy.maps.MapAxis" title="gammapy.maps.MapAxis"><code class="xref py py-obj docutils literal notranslate"><span class="pre">MapAxis</span></code></a> for the energy binnings: one for the
reconstructed (i.e.measured) energy, the other for the true energy
(i.e.the one used by IRFs and models)</p></li>
</ul>
</li>
<li><p>Create the necessary makers :</p>
<ul>
<li><p>the spectrum dataset maker : <a class="reference internal" href="../../api/gammapy.makers.SpectrumDatasetMaker.html#gammapy.makers.SpectrumDatasetMaker" title="gammapy.makers.SpectrumDatasetMaker"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SpectrumDatasetMaker</span></code></a> -
the OFF background maker, here a <a class="reference internal" href="../../api/gammapy.makers.ReflectedRegionsBackgroundMaker.html#gammapy.makers.ReflectedRegionsBackgroundMaker" title="gammapy.makers.ReflectedRegionsBackgroundMaker"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ReflectedRegionsBackgroundMaker</span></code></a></p></li>
<li><p>and the safe range maker : <a class="reference internal" href="../../api/gammapy.makers.SafeMaskMaker.html#gammapy.makers.SafeMaskMaker" title="gammapy.makers.SafeMaskMaker"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SafeMaskMaker</span></code></a></p></li>
</ul>
</li>
<li><p>Perform the data reduction loop. And for every observation:</p>
<ul>
<li><p>Apply the makers sequentially to produce a <a class="reference internal" href="../../api/gammapy.datasets.SpectrumDatasetOnOff.html#gammapy.datasets.SpectrumDatasetOnOff" title="gammapy.datasets.SpectrumDatasetOnOff"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code></a></p></li>
<li><p>Append it to list of datasets</p></li>
</ul>
</li>
<li><p>Define the <a class="reference internal" href="../../api/gammapy.modeling.models.SkyModel.html#gammapy.modeling.models.SkyModel" title="gammapy.modeling.models.SkyModel"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SkyModel</span></code></a> to apply to the dataset.</p></li>
<li><p>Create a <a class="reference internal" href="../../api/gammapy.modeling.Fit.html#gammapy.modeling.Fit" title="gammapy.modeling.Fit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Fit</span></code></a> object and run it to fit the model parameters</p></li>
<li><p>Apply a <a class="reference internal" href="../../api/gammapy.estimators.FluxPointsEstimator.html#gammapy.estimators.FluxPointsEstimator" title="gammapy.estimators.FluxPointsEstimator"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FluxPointsEstimator</span></code></a> to compute flux points for
the spectral part of the fit.</p></li>
</ul>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Check package versions</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span>

<span class="c1"># %matplotlib inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</section>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h2>
<p>As usual, we’ll start with some setup …</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">DataStore</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Datasets</span><span class="p">,</span>
    <span class="n">FluxPointsDataset</span><span class="p">,</span>
    <span class="n">SpectrumDataset</span><span class="p">,</span>
    <span class="n">SpectrumDatasetOnOff</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.estimators</span> <span class="kn">import</span> <span class="n">FluxPointsEstimator</span>
<span class="kn">from</span> <span class="nn">gammapy.estimators.utils</span> <span class="kn">import</span> <span class="n">resample_energy_edges</span>
<span class="kn">from</span> <span class="nn">gammapy.makers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">,</span>
    <span class="n">SafeMaskMaker</span><span class="p">,</span>
    <span class="n">SpectrumDatasetMaker</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">MapAxis</span><span class="p">,</span> <span class="n">RegionGeom</span><span class="p">,</span> <span class="n">WcsGeom</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling</span> <span class="kn">import</span> <span class="n">Fit</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExpCutoffPowerLawSpectralModel</span><span class="p">,</span>
    <span class="n">SkyModel</span><span class="p">,</span>
    <span class="n">create_crab_spectral_model</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="check-setup">
<h2>Check setup<a class="headerlink" href="#check-setup" title="Permalink to this headline">#</a></h2>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.utils.check</span> <span class="kn">import</span> <span class="n">check_tutorials_setup</span>
<span class="kn">from</span> <span class="nn">gammapy.visualization</span> <span class="kn">import</span> <span class="n">plot_spectrum_datasets_off_regions</span>

<span class="n">check_tutorials_setup</span><span class="p">()</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>System:

        python_executable      : /home/feijen/Documents/github/gammapy/.tox/build_docs/bin/python
        python_version         : 3.9.18
        machine                : x86_64
        system                 : Linux


Gammapy package:

        version                : 1.2.dev1423+gc6103d165.d20231211
        path                   : /home/feijen/Documents/github/gammapy/.tox/build_docs/lib/python3.9/site-packages/gammapy


Other packages:

        numpy                  : 1.26.2
        scipy                  : 1.11.4
        astropy                : 5.2.2
        regions                : 0.8
        click                  : 8.1.7
        yaml                   : 6.0.1
        IPython                : 8.18.1
        jupyterlab             : not installed
        matplotlib             : 3.8.2
        pandas                 : not installed
        healpy                 : 1.16.6
        iminuit                : 2.24.0
        sherpa                 : 4.16.0
        naima                  : 0.10.0
        emcee                  : 3.1.4
        corner                 : 2.2.2
        ray                    : 2.8.0


Gammapy environment variables:

        GAMMAPY_DATA           : /home/feijen/gammapy-datasets/1.1rc1
</pre></div>
</div>
</section>
<section id="load-data">
<h2>Load Data<a class="headerlink" href="#load-data" title="Permalink to this headline">#</a></h2>
<p>First, we select and load some H.E.S.S. observations of the Crab nebula
(simulated events for now).</p>
<p>We will access the events, effective area, energy dispersion, livetime
and PSF for containment correction.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">datastore</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s2">&quot;$GAMMAPY_DATA/hess-dl3-dr1/&quot;</span><span class="p">)</span>
<span class="n">obs_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">23523</span><span class="p">,</span> <span class="mi">23526</span><span class="p">,</span> <span class="mi">23559</span><span class="p">,</span> <span class="mi">23592</span><span class="p">]</span>
<span class="n">observations</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">get_observations</span><span class="p">(</span><span class="n">obs_ids</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="define-target-region">
<h2>Define Target Region<a class="headerlink" href="#define-target-region" title="Permalink to this headline">#</a></h2>
<p>The next step is to define a signal extraction region, also known as on
region. In the simplest case this is just a
<a class="reference external" href="http://astropy-regions.readthedocs.io/en/latest/api/regions.CircleSkyRegion.html">CircleSkyRegion</a>.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="mf">83.63</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mf">22.01</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>
<span class="n">on_region_radius</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="s2">&quot;0.11 deg&quot;</span><span class="p">)</span>
<span class="n">on_region</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="n">target_position</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">on_region_radius</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="create-exclusion-mask">
<h2>Create exclusion mask<a class="headerlink" href="#create-exclusion-mask" title="Permalink to this headline">#</a></h2>
<p>We will use the reflected regions method to place off regions to
estimate the background level in the on region. To make sure the off
regions don’t contain gamma-ray emission, we create an exclusion mask.</p>
<p>Using <a class="reference external" href="http://gamma-sky.net/">http://gamma-sky.net/</a> we find that there’s only one known
gamma-ray source near the Crab nebula: the AGN called <a class="reference external" href="http://gamma-sky.net/#/cat/tev/23">RGB
J0521+212</a> at GLON = 183.604 deg
and GLAT = -8.708 deg.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">exclusion_region</span> <span class="o">=</span> <span class="n">CircleSkyRegion</span><span class="p">(</span>
    <span class="n">center</span><span class="o">=</span><span class="n">SkyCoord</span><span class="p">(</span><span class="mf">183.604</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.708</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;galactic&quot;</span><span class="p">),</span>
    <span class="n">radius</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">skydir</span> <span class="o">=</span> <span class="n">target_position</span><span class="o">.</span><span class="n">galactic</span>
<span class="n">geom</span> <span class="o">=</span> <span class="n">WcsGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">npix</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="n">binsz</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">skydir</span><span class="o">=</span><span class="n">skydir</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;TAN&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span>
<span class="p">)</span>

<span class="n">exclusion_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">geom</span><span class="o">.</span><span class="n">region_mask</span><span class="p">([</span><span class="n">exclusion_region</span><span class="p">])</span>
<span class="n">exclusion_mask</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_spectral_analysis_001.png" srcset="../../_images/sphx_glr_spectral_analysis_001.png" alt="spectral analysis" class = "sphx-glr-single-img"/></section>
<section id="run-data-reduction-chain">
<h2>Run data reduction chain<a class="headerlink" href="#run-data-reduction-chain" title="Permalink to this headline">#</a></h2>
<p>We begin with the configuration of the maker classes:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_axis</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span>
    <span class="mf">0.1</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">per_decade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span>
<span class="p">)</span>
<span class="n">energy_axis_true</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span>
    <span class="mf">0.05</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">per_decade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy_true&quot;</span>
<span class="p">)</span>

<span class="n">geom</span> <span class="o">=</span> <span class="n">RegionGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">energy_axis</span><span class="p">])</span>
<span class="n">dataset_empty</span> <span class="o">=</span> <span class="n">SpectrumDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="n">energy_axis_true</span><span class="o">=</span><span class="n">energy_axis_true</span><span class="p">)</span>

<span class="n">dataset_maker</span> <span class="o">=</span> <span class="n">SpectrumDatasetMaker</span><span class="p">(</span>
    <span class="n">containment_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;exposure&quot;</span><span class="p">,</span> <span class="s2">&quot;edisp&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">bkg_maker</span> <span class="o">=</span> <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">(</span><span class="n">exclusion_mask</span><span class="o">=</span><span class="n">exclusion_mask</span><span class="p">)</span>
<span class="n">safe_mask_masker</span> <span class="o">=</span> <span class="n">SafeMaskMaker</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;aeff-max&quot;</span><span class="p">],</span> <span class="n">aeff_percent</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">()</span>

<span class="k">for</span> <span class="n">obs_id</span><span class="p">,</span> <span class="n">observation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obs_ids</span><span class="p">,</span> <span class="n">observations</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_empty</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">obs_id</span><span class="p">)),</span> <span class="n">observation</span><span class="p">)</span>
    <span class="n">dataset_on_off</span> <span class="o">=</span> <span class="n">bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
    <span class="n">dataset_on_off</span> <span class="o">=</span> <span class="n">safe_mask_masker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_on_off</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset_on_off</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Datasets
--------

Dataset 0:

  Type       : SpectrumDatasetOnOff
  Name       : 23523
  Instrument : HESS
  Models     :

Dataset 1:

  Type       : SpectrumDatasetOnOff
  Name       : 23526
  Instrument : HESS
  Models     :

Dataset 2:

  Type       : SpectrumDatasetOnOff
  Name       : 23559
  Instrument : HESS
  Models     :

Dataset 3:

  Type       : SpectrumDatasetOnOff
  Name       : 23592
  Instrument : HESS
  Models     :
</pre></div>
</div>
</section>
<section id="plot-off-regions">
<h2>Plot off regions<a class="headerlink" href="#plot-off-regions" title="Permalink to this headline">#</a></h2>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">exclusion_mask</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">on_region</span><span class="o">.</span><span class="n">to_pixel</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plot_spectrum_datasets_off_regions</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_spectral_analysis_002.png" srcset="../../_images/sphx_glr_spectral_analysis_002.png" alt="spectral analysis" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/feijen/Documents/github/gammapy/.tox/build_docs/lib/python3.9/site-packages/regions/shapes/circle.py:161: UserWarning: Setting the &#39;color&#39; property will override the edgecolor or facecolor properties.
  return Circle(xy=xy, radius=radius, **mpl_kwargs)
/home/feijen/Documents/github/gammapy/.tox/build_docs/lib/python3.9/site-packages/gammapy/visualization/datasets.py:84: UserWarning: Setting the &#39;color&#39; property will override the edgecolor or facecolor properties.
  handle = Patch(**plot_kwargs)
</pre></div>
</div>
</section>
<section id="source-statistic">
<h2>Source statistic<a class="headerlink" href="#source-statistic" title="Permalink to this headline">#</a></h2>
<p>Next we’re going to look at the overall source statistics in our signal
region.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">info_table</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">info_table</span><span class="p">(</span><span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">info_table</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  name  counts       excess      ...   acceptance_off          alpha
                                 ...
------- ------ ----------------- ... ------------------ -------------------
stacked    149            139.25 ...              216.0  0.0833333358168602
stacked    303            280.75 ... 227.99996948242188  0.0833333432674408
stacked    439 408.7743835449219 ...  373.3919677734375 0.05088486522436142
stacked    550  512.135498046875 ... 436.05487060546875 0.04357249662280083
</pre></div>
</div>
<p>And make the corresponding plots</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax_excess</span><span class="p">,</span> <span class="n">ax_sqrt_ts</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax_excess</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">info_table</span><span class="p">[</span><span class="s2">&quot;livetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">),</span>
    <span class="n">info_table</span><span class="p">[</span><span class="s2">&quot;excess&quot;</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax_excess</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Excess&quot;</span><span class="p">)</span>
<span class="n">ax_excess</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Livetime [h]&quot;</span><span class="p">)</span>
<span class="n">ax_excess</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Excess events&quot;</span><span class="p">)</span>

<span class="n">ax_sqrt_ts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">info_table</span><span class="p">[</span><span class="s2">&quot;livetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">),</span>
    <span class="n">info_table</span><span class="p">[</span><span class="s2">&quot;sqrt_ts&quot;</span><span class="p">],</span>
    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax_sqrt_ts</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Sqrt(TS)&quot;</span><span class="p">)</span>
<span class="n">ax_sqrt_ts</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Livetime [h]&quot;</span><span class="p">)</span>
<span class="n">ax_sqrt_ts</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Sqrt(TS)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_spectral_analysis_003.png" srcset="../../_images/sphx_glr_spectral_analysis_003.png" alt="Excess, Sqrt(TS)" class = "sphx-glr-single-img"/><p>Finally you can write the extracted datasets to disk using the OGIP
format (PHA, ARF, RMF, BKG, see
<a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/spectra/ogip/index.html">here</a>
for details):</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;spectrum_analysis&quot;</span><span class="p">)</span>
<span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;obs_</span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.fits.gz&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to read back the datasets from disk you can use:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">()</span>

<span class="k">for</span> <span class="n">obs_id</span> <span class="ow">in</span> <span class="n">obs_ids</span><span class="p">:</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;obs_</span><span class="si">{</span><span class="n">obs_id</span><span class="si">}</span><span class="s2">.fits.gz&quot;</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SpectrumDatasetOnOff</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="fit-spectrum">
<h2>Fit spectrum<a class="headerlink" href="#fit-spectrum" title="Permalink to this headline">#</a></h2>
<p>Now we’ll fit a global model to the spectrum. First we do a joint
likelihood fit to all observations. If you want to stack the
observations see below. We will also produce a debug plot in order to
show how the global fit matches one of the individual observations.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectral_model</span> <span class="o">=</span> <span class="n">ExpCutoffPowerLawSpectralModel</span><span class="p">(</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1e-12</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;cm-2 s-1 TeV-1&quot;</span><span class="p">),</span>
    <span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">lambda_</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;TeV-1&quot;</span><span class="p">),</span>
    <span class="n">reference</span><span class="o">=</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spectral_model</span><span class="o">=</span><span class="n">spectral_model</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;crab&quot;</span><span class="p">)</span>

<span class="n">datasets</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>

<span class="n">fit_joint</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">()</span>
<span class="n">result_joint</span> <span class="o">=</span> <span class="n">fit_joint</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">)</span>

<span class="c1"># we make a copy here to compare it later</span>
<span class="n">model_best_joint</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="fit-quality-and-model-residuals">
<h2>Fit quality and model residuals<a class="headerlink" href="#fit-quality-and-model-residuals" title="Permalink to this headline">#</a></h2>
<p>We can access the results dictionary to see if the fit converged:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result_joint</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>OptimizeResult

        backend    : minuit
        method     : migrad
        success    : True
        message    : Optimization terminated successfully.
        nfev       : 244
        total stat : 86.12

CovarianceResult

        backend    : minuit
        method     : hesse
        success    : True
        message    : Hesse terminated successfully.
</pre></div>
</div>
<p>and check the best-fit parameters</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">result_joint</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">to_parameters_table</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>model   type      name     value         unit      ... frozen is_norm link prior
----- -------- --------- ---------- -------------- ... ------ ------- ---- -----
 crab spectral     index 2.2727e+00                ...  False   False       None
 crab spectral amplitude 4.7913e-11 cm-2 s-1 TeV-1 ...  False    True       None
 crab spectral reference 1.0000e+00            TeV ...   True   False       None
 crab spectral   lambda_ 1.2097e-01          TeV-1 ...  False   False       None
 crab spectral     alpha 1.0000e+00                ...   True   False       None
</pre></div>
</div>
<p>A simple way to inspect the model residuals is using the function
<code class="xref py py-obj docutils literal notranslate"><span class="pre">plot_fit()</span></code></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax_spectrum</span><span class="p">,</span> <span class="n">ax_residuals</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">()</span>
<span class="n">ax_spectrum</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
<span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_masks</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_spectrum</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_spectral_analysis_004.png" srcset="../../_images/sphx_glr_spectral_analysis_004.png" alt="spectral analysis" class = "sphx-glr-single-img"/><p>For more ways of assessing fit quality, please refer to the dedicated
<a class="reference internal" href="../api/fitting.html"><span class="doc">Fitting</span></a> tutorial.</p>
</section>
<section id="compute-flux-points">
<h2>Compute Flux Points<a class="headerlink" href="#compute-flux-points" title="Permalink to this headline">#</a></h2>
<p>To round up our analysis we can compute flux points by fitting the norm
of the global model in energy bands.
We can utilise the <a class="reference internal" href="../../api/gammapy.estimators.utils.resample_energy_edges.html#gammapy.estimators.utils.resample_energy_edges" title="gammapy.estimators.utils.resample_energy_edges"><code class="xref py py-obj docutils literal notranslate"><span class="pre">resample_energy_edges</span></code></a>
for defining the energy bins in which the minimum number of <code class="xref py py-obj docutils literal notranslate"><span class="pre">sqrt_ts</span></code> is 2.
To do so we first stack the individual datasets, only for obtaining the energies:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_stacked</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="o">.</span><span class="n">stack_reduce</span><span class="p">()</span>
<span class="n">energy_edges</span> <span class="o">=</span> <span class="n">resample_energy_edges</span><span class="p">(</span><span class="n">dataset_stacked</span><span class="p">,</span> <span class="n">conditions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sqrt_ts_min&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</pre></div>
</div>
<p>Now we create an instance of the
<a class="reference internal" href="../../api/gammapy.estimators.FluxPointsEstimator.html#gammapy.estimators.FluxPointsEstimator" title="gammapy.estimators.FluxPointsEstimator"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FluxPointsEstimator</span></code></a>, by passing the dataset and
the energy binning:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpe</span> <span class="o">=</span> <span class="n">FluxPointsEstimator</span><span class="p">(</span>
    <span class="n">energy_edges</span><span class="o">=</span><span class="n">energy_edges</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;crab&quot;</span><span class="p">,</span> <span class="n">selection_optional</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
<span class="p">)</span>
<span class="n">flux_points</span> <span class="o">=</span> <span class="n">fpe</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is a the table of the resulting flux points:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">flux_points</span><span class="o">.</span><span class="n">to_table</span><span class="p">(</span><span class="n">sed_type</span><span class="o">=</span><span class="s2">&quot;dnde&quot;</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>e_ref  e_min  e_max  ... success   norm_scan        stat_scan
 TeV    TeV    TeV   ...
------ ------ ------ ... ------- -------------- ------------------
 0.659  0.590  0.737 ...    True 0.200 .. 5.000  62.683 .. 252.535
 0.823  0.737  0.920 ...    True 0.200 .. 5.000 140.739 .. 451.124
 1.028  0.920  1.148 ...    True 0.200 .. 5.000 105.409 .. 381.859
 1.283  1.148  1.434 ...    True 0.200 .. 5.000  77.194 .. 311.795
 1.602  1.434  1.790 ...    True 0.200 .. 5.000  88.719 .. 221.364
 2.000  1.790  2.235 ...    True 0.200 .. 5.000  62.080 .. 203.491
 2.497  2.235  2.790 ...    True 0.200 .. 5.000  57.228 .. 169.536
 3.117  2.790  3.483 ...    True 0.200 .. 5.000  45.318 .. 123.910
 3.892  3.483  4.348 ...    True 0.200 .. 5.000  13.594 .. 125.092
 4.859  4.348  5.429 ...    True 0.200 .. 5.000   31.556 .. 80.689
 6.066  5.429  6.778 ...    True 0.200 .. 5.000   15.545 .. 51.420
 7.573  6.778  8.462 ...    True 0.200 .. 5.000   16.394 .. 34.290
 9.454  8.462 10.564 ...    True 0.200 .. 5.000   12.081 .. 21.493
20.556 10.564 40.000 ...    True 0.200 .. 5.000   22.913 .. 43.864
</pre></div>
</div>
<p>Now we plot the flux points and their likelihood profiles. For the
plotting of upper limits we choose a threshold of TS &lt; 4.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">flux_points</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">sed_type</span><span class="o">=</span><span class="s2">&quot;e2dnde&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">)</span>
<span class="n">flux_points</span><span class="o">.</span><span class="n">plot_ts_profiles</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">sed_type</span><span class="o">=</span><span class="s2">&quot;e2dnde&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_spectral_analysis_005.png" srcset="../../_images/sphx_glr_spectral_analysis_005.png" alt="spectral analysis" class = "sphx-glr-single-img"/><p>The final plot with the best fit model, flux points and residuals can be
quickly made like this:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">flux_points_dataset</span> <span class="o">=</span> <span class="n">FluxPointsDataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">flux_points</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="n">model_best_joint</span><span class="p">)</span>
<span class="n">flux_points_dataset</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_spectral_analysis_006.png" srcset="../../_images/sphx_glr_spectral_analysis_006.png" alt="spectral analysis" class = "sphx-glr-single-img"/></section>
<section id="stack-observations">
<h2>Stack observations<a class="headerlink" href="#stack-observations" title="Permalink to this headline">#</a></h2>
<p>An alternative approach to fitting the spectrum is stacking all
observations first and the fitting a model. For this we first stack the
individual datasets:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_stacked</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span><span class="o">.</span><span class="n">stack_reduce</span><span class="p">()</span>
</pre></div>
</div>
<p>Again we set the model on the dataset we would like to fit (in this case
it’s only a single one) and pass it to the <a class="reference internal" href="../../api/gammapy.modeling.Fit.html#gammapy.modeling.Fit" title="gammapy.modeling.Fit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Fit</span></code></a>
object:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_stacked</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">model</span>
<span class="n">stacked_fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">()</span>
<span class="n">result_stacked</span> <span class="o">=</span> <span class="n">stacked_fit</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">dataset_stacked</span><span class="p">])</span>

<span class="c1"># Make a copy to compare later</span>
<span class="n">model_best_stacked</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">result_stacked</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>OptimizeResult

        backend    : minuit
        method     : migrad
        success    : True
        message    : Optimization terminated successfully.
        nfev       : 54
        total stat : 8.16

CovarianceResult

        backend    : minuit
        method     : hesse
        success    : True
        message    : Hesse terminated successfully.
</pre></div>
</div>
<p>And display the parameter table</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">model_best_joint</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">to_table</span><span class="p">())</span>

<span class="n">display</span><span class="p">(</span><span class="n">model_best_stacked</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">to_table</span><span class="p">())</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  type      name     value         unit      ... frozen is_norm link prior
-------- --------- ---------- -------------- ... ------ ------- ---- -----
spectral     index 2.2727e+00                ...  False   False       None
spectral amplitude 4.7913e-11 cm-2 s-1 TeV-1 ...  False    True       None
spectral reference 1.0000e+00            TeV ...   True   False       None
spectral   lambda_ 1.2097e-01          TeV-1 ...  False   False       None
spectral     alpha 1.0000e+00                ...   True   False       None
  type      name     value         unit      ... frozen is_norm link prior
-------- --------- ---------- -------------- ... ------ ------- ---- -----
spectral     index 2.2785e+00                ...  False   False       None
spectral amplitude 4.7800e-11 cm-2 s-1 TeV-1 ...  False    True       None
spectral reference 1.0000e+00            TeV ...   True   False       None
spectral   lambda_ 1.1830e-01          TeV-1 ...  False   False       None
spectral     alpha 1.0000e+00                ...   True   False       None
</pre></div>
</div>
<p>Finally, we compare the results of our stacked analysis to a previously
published Crab Nebula Spectrum for reference. This is available in
<a class="reference internal" href="../../api/gammapy.modeling.models.create_crab_spectral_model.html#gammapy.modeling.models.create_crab_spectral_model" title="gammapy.modeling.models.create_crab_spectral_model"><code class="xref py py-obj docutils literal notranslate"><span class="pre">create_crab_spectral_model</span></code></a>.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;energy_bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
    <span class="s2">&quot;sed_type&quot;</span><span class="p">:</span> <span class="s2">&quot;e2dnde&quot;</span><span class="p">,</span>
    <span class="s2">&quot;yunits&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;erg cm-2 s-1&quot;</span><span class="p">),</span>
    <span class="s2">&quot;ax&quot;</span><span class="p">:</span> <span class="n">ax</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># plot stacked model</span>
<span class="n">model_best_stacked</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stacked analysis result&quot;</span><span class="p">)</span>
<span class="n">model_best_stacked</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot_error</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

<span class="c1"># plot joint model</span>
<span class="n">model_best_joint</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Joint analysis result&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span>
<span class="p">)</span>
<span class="n">model_best_joint</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot_error</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

<span class="n">create_crab_spectral_model</span><span class="p">(</span><span class="s2">&quot;hess_ecpl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Crab reference&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># sphinx_gallery_thumbnail_number = 5</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_spectral_analysis_007.png" srcset="../../_images/sphx_glr_spectral_analysis_007.png" alt="spectral analysis" class = "sphx-glr-single-img"/></section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">#</a></h2>
<p>Now you have learned the basics of a spectral analysis with Gammapy. To
practice you can continue with the following exercises:</p>
<ul class="simple">
<li><p>Fit a different spectral model to the data. You could try
<a class="reference internal" href="../../api/gammapy.modeling.models.ExpCutoffPowerLawSpectralModel.html#gammapy.modeling.models.ExpCutoffPowerLawSpectralModel" title="gammapy.modeling.models.ExpCutoffPowerLawSpectralModel"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ExpCutoffPowerLawSpectralModel</span></code></a> or
<a class="reference internal" href="../../api/gammapy.modeling.models.LogParabolaSpectralModel.html#gammapy.modeling.models.LogParabolaSpectralModel" title="gammapy.modeling.models.LogParabolaSpectralModel"><code class="xref py py-obj docutils literal notranslate"><span class="pre">LogParabolaSpectralModel</span></code></a>.</p></li>
<li><p>Compute flux points for the stacked dataset.</p></li>
<li><p>Create a <a class="reference internal" href="../../api/gammapy.datasets.FluxPointsDataset.html#gammapy.datasets.FluxPointsDataset" title="gammapy.datasets.FluxPointsDataset"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FluxPointsDataset</span></code></a> with the flux points
you have computed for the stacked dataset and fit the flux points
again with obe of the spectral models. How does the result compare to
the best fit model, that was directly fitted to the counts data?</p></li>
</ul>
</section>
<section id="what-next">
<h2>What next?<a class="headerlink" href="#what-next" title="Permalink to this headline">#</a></h2>
<p>The methods shown in this tutorial is valid for point-like or midly
extended sources where we can assume that the IRF taken at the region
center is valid over the whole region. If one wants to extract the 1D
spectrum of a large source and properly average the response over the
extraction region, one has to use a different approach explained in
the <a class="reference internal" href="extended_source_spectral_analysis.html"><span class="doc">Spectral analysis of extended sources</span></a>
tutorial.</p>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  13.623 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-tutorials-analysis-1d-spectral-analysis-py">
<div class="binder-badge docutils container">
<a class="reference external image-reference" href="https://mybinder.org/v2/gh/gammapy/gammapy-webpage/master?urlpath=lab/tree/notebooks/dev/tutorials/analysis-1d/spectral_analysis.ipynb"><img alt="Launch binder" src="../../_images/binder_badge_logo.svg" width="150px" /></a>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/e0a543cc50809937467ce947bbbfc283/spectral_analysis.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">spectral_analysis.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/ac30ac3c375ddb5b0d1e27c90650e55b/spectral_analysis.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">spectral_analysis.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2024, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>