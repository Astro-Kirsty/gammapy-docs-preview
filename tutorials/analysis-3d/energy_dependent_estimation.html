
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Morphological energy dependence estimation &#8212; gammapy vX.Y.Z</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../development/index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        dev  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables tutorials/analysis-3d/energy_dependent_estimation and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': 'dev'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "tutorials/analysis-3d/energy_dependent_estimation.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "tutorials/analysis-3d/energy_dependent_estimation.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.2.dev1723+gcc78c6251.d20240301 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "dev") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prerequisites">
   Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#context">
   Context
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#tutorial-overview">
   Tutorial overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#check-setup">
   Check setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#obtain-the-data-to-use">
   Obtain the data to use
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-estimator">
   Run Estimator
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#show-the-results-tables">
   Show the results tables
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-results-of-the-source-signal-above-the-background-in-each-energy-bin">
     The results of the source signal above the background in each energy bin
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-results-for-testing-energy-dependence">
     The results for testing energy dependence
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-chi-squared-value-for-each-parameter-of-interest">
     The chi-squared value for each parameter of interest
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plotting-the-results">
   Plotting the results
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-tutorials-analysis-3d-energy-dependent-estimation-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code or to run this example in your browser via Binder</p>
</div>
<section class="sphx-glr-example-title" id="morphological-energy-dependence-estimation">
<span id="sphx-glr-tutorials-analysis-3d-energy-dependent-estimation-py"></span><h1>Morphological energy dependence estimation<a class="headerlink" href="#morphological-energy-dependence-estimation" title="Permalink to this headline">#</a></h1>
<p>Learn how to test for energy-dependent morphology in your dataset.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">#</a></h2>
<p>Knowledge on data reduction and datasets used in Gammapy, for example see
the <a class="reference internal" href="../data/hess.html"><span class="doc">H.E.S.S. with Gammapy</span></a> and <a class="reference internal" href="../analysis-2d/ring_background.html"><span class="doc">Ring background map</span></a> tutorials.</p>
</section>
<section id="context">
<h2>Context<a class="headerlink" href="#context" title="Permalink to this headline">#</a></h2>
<p>This tutorial introduces a method to investigate the potential of energy-dependent morphology from spatial maps.
It is possible for gamma-ray sources to exhibit energy-dependent morphology, in which the spatial morphology of
the gamma rays varies across different energy bands. This is plausible for different source types, including pulsar
wind nebulae (PWNe) and supernova remnants. HESS J1825−137 is a well-known example of a PWNe which shows a clear
energy-dependent gamma-ray morphology (see <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2019A%26A...621A.116H/abstract">Aharonian et al., 2006</a>,
<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2006A%26A...460..365A/abstract">H.E.S.S. Collaboration et al., 2019</a> and
<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2020A%26A...640A..76P/abstract">Principe et al., 2020</a>.)</p>
<p>Many different techniques of measuring this energy-dependence have been utilised over the years.
The method shown here is to perform a morphological fit of extension and position in various energy slices and
compare this with a global morphology fit.</p>
<p><strong>Objective: Perform an energy-dependent morphology study of a mock source.</strong></p>
</section>
<section id="tutorial-overview">
<h2>Tutorial overview<a class="headerlink" href="#tutorial-overview" title="Permalink to this headline">#</a></h2>
<p>This tutorial consists of two main steps.</p>
<p>Firstly, the user defines the initial <a class="reference internal" href="../../api/gammapy.modeling.models.SkyModel.html#gammapy.modeling.models.SkyModel" title="gammapy.modeling.models.SkyModel"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SkyModel</span></code></a> based on previous investigations
and selects the energy bands of interest to test for energy dependence. The null hypothesis is defined as
only the background component being free (norm). The alternative hypothesis introduces the source model.
The results of this first step show the significance of the source above the background in each energy band.</p>
<p>The second step is to quantify any energy-dependent morphology. The null hypothesis is determined by performing
a joint fit of the parameters. In the alternative hypothesis, the free parameters of the model are fit
individually within each energy band.</p>
</section>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h2>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="n">Datasets</span><span class="p">,</span> <span class="n">MapDataset</span>
<span class="kn">from</span> <span class="nn">gammapy.estimators</span> <span class="kn">import</span> <span class="n">EnergyDependentMorphologyEstimator</span>
<span class="kn">from</span> <span class="nn">gammapy.estimators.energydependentmorphology</span> <span class="kn">import</span> <span class="n">weighted_chi2_parameter</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">Map</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GaussianSpatialModel</span><span class="p">,</span>
    <span class="n">PowerLawSpectralModel</span><span class="p">,</span>
    <span class="n">SkyModel</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.stats.utils</span> <span class="kn">import</span> <span class="n">ts_to_sigma</span>
<span class="kn">from</span> <span class="nn">gammapy.utils.check</span> <span class="kn">import</span> <span class="n">check_tutorials_setup</span>
</pre></div>
</div>
</section>
<section id="check-setup">
<h2>Check setup<a class="headerlink" href="#check-setup" title="Permalink to this headline">#</a></h2>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_tutorials_setup</span><span class="p">()</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>System:

        python_executable      : /home/feijen/Documents/github/gammapy/.tox/build_docs/bin/python
        python_version         : 3.9.18
        machine                : x86_64
        system                 : Linux


Gammapy package:

        version                : 1.2.dev1813+g9f8503aa9
        path                   : /home/feijen/Documents/github/gammapy/.tox/build_docs/lib/python3.9/site-packages/gammapy


Other packages:

        numpy                  : 1.26.3
        scipy                  : 1.12.0
        astropy                : 5.2.2
        regions                : 0.8
        click                  : 8.1.7
        yaml                   : 6.0.1
        IPython                : 8.18.1
        jupyterlab             : not installed
        matplotlib             : 3.8.2
        pandas                 : not installed
        healpy                 : 1.16.6
        iminuit                : 2.25.0
        sherpa                 : 4.16.0
        naima                  : 0.10.0
        emcee                  : 3.1.4
        corner                 : 2.2.2
        ray                    : 2.9.1


Gammapy environment variables:

        GAMMAPY_DATA           : /home/feijen/gammapy-datasets/dev
</pre></div>
</div>
</section>
<section id="obtain-the-data-to-use">
<h2>Obtain the data to use<a class="headerlink" href="#obtain-the-data-to-use" title="Permalink to this headline">#</a></h2>
<p>Utilise the pre-defined dataset within <code class="xref py py-obj docutils literal notranslate"><span class="pre">$GAMMAPY_DATA</span></code>.</p>
<p>P.S.: do not forget to set up your environment variable <code class="xref py py-obj docutils literal notranslate"><span class="pre">$GAMMAPY_DATA</span></code>
to your local directory.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">stacked_dataset</span> <span class="o">=</span> <span class="n">MapDataset</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
    <span class="s2">&quot;$GAMMAPY_DATA/estimators/mock_DL4/dataset_energy_dependent.fits.gz&quot;</span>
<span class="p">)</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">([</span><span class="n">stacked_dataset</span><span class="p">])</span>
</pre></div>
</div>
<p>Define the energy edges of interest. These will be utilised to
investigate the potential of energy-dependent morphology in the dataset.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_edges</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>
</pre></div>
</div>
<p>Define the spectral and spatial models of interest. We utilise
a <a class="reference internal" href="../../api/gammapy.modeling.models.PowerLawSpectralModel.html#gammapy.modeling.models.PowerLawSpectralModel" title="gammapy.modeling.models.PowerLawSpectralModel"><code class="xref py py-obj docutils literal notranslate"><span class="pre">PowerLawSpectralModel</span></code></a> and a
<a class="reference internal" href="../../api/gammapy.modeling.models.GaussianSpatialModel.html#gammapy.modeling.models.GaussianSpatialModel" title="gammapy.modeling.models.GaussianSpatialModel"><code class="xref py py-obj docutils literal notranslate"><span class="pre">GaussianSpatialModel</span></code></a> to test the energy-dependent
morphology component in each energy band. A standard 3D fit (see the
<a class="reference internal" href="analysis_3d.html"><span class="doc">3D detailed analysis</span></a> tutorial)
is performed, then the best fit model is utilised here for the initial parameters
in each model.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">source_position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="mf">5.58</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;galactic&quot;</span><span class="p">)</span>

<span class="n">spectral_model</span> <span class="o">=</span> <span class="n">PowerLawSpectralModel</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">9.8e-12</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;cm-2 s-1 TeV-1&quot;</span><span class="p">),</span> <span class="n">reference</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>
<span class="p">)</span>

<span class="n">spatial_model</span> <span class="o">=</span> <span class="n">GaussianSpatialModel</span><span class="p">(</span>
    <span class="n">lon_0</span><span class="o">=</span><span class="n">source_position</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>
    <span class="n">lat_0</span><span class="o">=</span><span class="n">source_position</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
    <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;galactic&quot;</span><span class="p">,</span>
    <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Limit the search for the position on the spatial model</span>
<span class="n">spatial_model</span><span class="o">.</span><span class="n">lon_0</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">source_position</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">deg</span> <span class="o">-</span> <span class="mf">0.8</span>
<span class="n">spatial_model</span><span class="o">.</span><span class="n">lon_0</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">source_position</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">deg</span> <span class="o">+</span> <span class="mf">0.8</span>
<span class="n">spatial_model</span><span class="o">.</span><span class="n">lat_0</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">source_position</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">deg</span> <span class="o">-</span> <span class="mf">0.8</span>
<span class="n">spatial_model</span><span class="o">.</span><span class="n">lat_0</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">source_position</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">deg</span> <span class="o">+</span> <span class="mf">0.8</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spatial_model</span><span class="o">=</span><span class="n">spatial_model</span><span class="p">,</span> <span class="n">spectral_model</span><span class="o">=</span><span class="n">spectral_model</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;src&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="run-estimator">
<h2>Run Estimator<a class="headerlink" href="#run-estimator" title="Permalink to this headline">#</a></h2>
<p>We can now run the energy-dependent estimation tool and explore the results.</p>
<p>Let’s start with the initial hypothesis, in which the source is introduced
to compare with the background. We specify which parameters we
wish to use for testing the energy dependence.
To test for the energy dependence, it is recommended to keep the position and
extension parameters free. This allows them to be used for fitting the spatial model
in each energy band.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">spatial_model</span><span class="o">.</span><span class="n">lon_0</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">model</span><span class="o">.</span><span class="n">spatial_model</span><span class="o">.</span><span class="n">lat_0</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">model</span><span class="o">.</span><span class="n">spatial_model</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">model</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">model</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">datasets</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">model</span>

<span class="n">estimator</span> <span class="o">=</span> <span class="n">EnergyDependentMorphologyEstimator</span><span class="p">(</span><span class="n">energy_edges</span><span class="o">=</span><span class="n">energy_edges</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;src&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="show-the-results-tables">
<h2>Show the results tables<a class="headerlink" href="#show-the-results-tables" title="Permalink to this headline">#</a></h2>
<section id="the-results-of-the-source-signal-above-the-background-in-each-energy-bin">
<h3>The results of the source signal above the background in each energy bin<a class="headerlink" href="#the-results-of-the-source-signal-above-the-background-in-each-energy-bin" title="Permalink to this headline">#</a></h3>
<p>Firstly, the estimator is run to produce the results.
The table here shows the ∆(TS) value, the number of degrees of freedom (df)
and the significance (σ) in each energy bin. The significance values here show that each
energy band has significant signal above the background.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
<span class="n">table_bkg_src</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;src_above_bkg&quot;</span><span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">table_bkg_src</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Emin Emax      delta_ts      df    significance
TeV  TeV
---- ---- ----------------- --- ------------------
 1.0  3.0 972.6524522136606   4 30.870071823681624
 3.0  5.0 698.2916633963614   4  26.06911863160015
 5.0 20.0 289.8437703157979   4    16.547095956069
</pre></div>
</div>
</section>
<section id="the-results-for-testing-energy-dependence">
<h3>The results for testing energy dependence<a class="headerlink" href="#the-results-for-testing-energy-dependence" title="Permalink to this headline">#</a></h3>
<p>Next, the results of the energy-dependent estimator are shown.
The table shows the various free parameters for the joint fit for <span class="math notranslate nohighlight">\(H_0\)</span> across the entire
energy band and for each energy bin shown for <span class="math notranslate nohighlight">\(H_1\)</span>.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_dependence&quot;</span><span class="p">][</span><span class="s2">&quot;delta_ts&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_dependence&quot;</span><span class="p">][</span><span class="s2">&quot;df&quot;</span><span class="p">]</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">ts_to_sigma</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The delta_ts for the energy-dependent study: </span><span class="si">{</span><span class="n">ts</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting this to a significance gives: </span><span class="si">{</span><span class="n">sigma</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="se">\u03C3</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">results_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_dependence&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">results_table</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>The delta_ts for the energy-dependent study: 75.596.
Converting this to a significance gives: 7.603 σ
Hypothesis Emin Emax ...        sigma             sigma_err
           TeV  TeV  ...         deg                 deg
---------- ---- ---- ... ------------------- --------------------
        H0  1.0 20.0 ... 0.21469420116756052 0.005926654348947036
        H1  1.0  3.0 ... 0.25640217669446475 0.009488770111122315
        H1  3.0  5.0 ... 0.19704826941259612 0.008176908174282039
        H1  5.0 20.0 ... 0.13529073828091737  0.00890507389083128
</pre></div>
</div>
</section>
<section id="the-chi-squared-value-for-each-parameter-of-interest">
<h3>The chi-squared value for each parameter of interest<a class="headerlink" href="#the-chi-squared-value-for-each-parameter-of-interest" title="Permalink to this headline">#</a></h3>
<p>We can also utilise the <code class="xref py py-obj docutils literal notranslate"><span class="pre">weighted_chi2_parameter</span></code>
function for each parameter.</p>
<p>The weighted chi-squared significance for the <code class="docutils literal notranslate"><span class="pre">sigma</span></code>, <code class="docutils literal notranslate"><span class="pre">lat_0</span></code> and <code class="docutils literal notranslate"><span class="pre">lon_0</span></code> values.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span>
    <span class="n">Table</span><span class="p">(</span>
        <span class="n">weighted_chi2_parameter</span><span class="p">(</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_dependence&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">],</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="s2">&quot;lat_0&quot;</span><span class="p">,</span> <span class="s2">&quot;lon_0&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>parameter        chi2         df    significance
--------- ------------------ --- ------------------
    sigma  86.85310388045771   2   9.05380882444822
    lat_0 4.6709072339461315   2 1.6607355133423811
    lon_0  1.300558786013642   2 0.6404194500982603
</pre></div>
</div>
<p>Note: The chi-squared parameter does not include potential correlation between the
parameters, so it should be used cautiously.</p>
</section>
</section>
<section id="plotting-the-results">
<h2>Plotting the results<a class="headerlink" href="#plotting-the-results" title="Permalink to this headline">#</a></h2>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">empty_map</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">skydir</span><span class="o">=</span><span class="n">spatial_model</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">spatial_model</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">binsz</span><span class="o">=</span><span class="mf">0.02</span>
<span class="p">)</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;magenta&quot;</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">empty_map</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">lat_0</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_dependence&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;lat_0&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">lat_0_err</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_dependence&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;lat_0_err&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">lon_0</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_dependence&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;lon_0&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">lon_0_err</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_dependence&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;lon_0_err&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_dependence&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;sigma&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
<span class="n">sigma_err</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;energy_dependence&quot;</span><span class="p">][</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;sigma_err&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lat_0</span><span class="p">)):</span>
    <span class="n">model_plot</span> <span class="o">=</span> <span class="n">GaussianSpatialModel</span><span class="p">(</span>
        <span class="n">lat_0</span><span class="o">=</span><span class="n">lat_0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lon_0</span><span class="o">=</span><span class="n">lon_0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="n">spatial_model</span><span class="o">.</span><span class="n">frame</span>
    <span class="p">)</span>
    <span class="n">model_plot</span><span class="o">.</span><span class="n">lat_0</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">lat_0_err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">model_plot</span><span class="o">.</span><span class="n">lon_0</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">lon_0_err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">model_plot</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">sigma_err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">model_plot</span><span class="o">.</span><span class="n">plot_error</span><span class="p">(</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">which</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">kwargs_extension</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;facecolor&quot;</span><span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]},</span>
        <span class="n">kwargs_position</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]},</span>
    <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># sphinx_gallery_thumbnail_number = 2</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_energy_dependent_estimation_001.png" srcset="../../_images/sphx_glr_energy_dependent_estimation_001.png" alt="energy dependent estimation" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  17.129 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-tutorials-analysis-3d-energy-dependent-estimation-py">
<div class="binder-badge docutils container">
<a class="reference external image-reference" href="https://mybinder.org/v2/gh/gammapy/gammapy-webpage/master?urlpath=lab/tree/notebooks/dev/tutorials/analysis-3d/energy_dependent_estimation.ipynb"><img alt="Launch binder" src="../../_images/binder_badge_logo2.svg" width="150px" /></a>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/1ccaeffb4e281faa566ce00a9de4d42f/energy_dependent_estimation.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">energy_dependent_estimation.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/6cbb580c802d458206b6a0123d909650/energy_dependent_estimation.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">energy_dependent_estimation.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2024, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>