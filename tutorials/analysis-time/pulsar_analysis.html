
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Pulsar analysis &#8212; gammapy vX.Y.Z</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gammapy.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <link rel="shortcut icon" href="../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Dark matter spatial and spectral models" href="../api/astro_dark_matter.html" />
    <link rel="prev" title="Simulating and fitting a time varying source" href="light_curve_simulation.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../user-guide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../api-reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../development/index.html">
  Developer guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../release-notes/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        dev  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables tutorials/analysis-time/pulsar_analysis and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'version_match': 'dev'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "tutorials/analysis-time/pulsar_analysis.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "tutorials/analysis-time/pulsar_analysis.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.2.dev1721+g6c725d50c variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "dev") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/analysis_1.html">
   High level interface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/analysis_2.html">
   Low level API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../starting/overview.html">
   Data structures
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../data/cta.html">
   CTA with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/fermi_lat.html">
   Fermi-LAT with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/hawc.html">
   HAWC with Gammapy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/hess.html">
   H.E.S.S. with Gammapy
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-1d/cta_sensitivity.html">
   Point source sensitivity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-1d/extended_source_spectral_analysis.html">
   Spectral analysis of extended sources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-1d/sed_fitting.html">
   Flux point fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-1d/spectral_analysis.html">
   Spectral analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-1d/spectral_analysis_hli.html">
   Spectral analysis with the HLI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-1d/spectral_analysis_rad_max.html">
   Spectral analysis with energy-dependent directional cuts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-1d/spectrum_simulation.html">
   1D spectrum simulation
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-2d/detect.html">
   Source detection and significance maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-2d/modeling_2D.html">
   2D map fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-2d/ring_background.html">
   Ring background map
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/analysis_3d.html">
   3D detailed analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/analysis_mwl.html">
   Multi instrument joint 3D and 1D analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/cta_data_analysis.html">
   Basic image exploration and fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/event_sampling.html">
   Event sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/event_sampling_nrg_depend_models.html">
   Sample a source with energy-dependent temporal evolution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/flux_profiles.html">
   Flux Profile Estimation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../analysis-3d/simulate_3d.html">
   3D map simulation
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Variability_estimation.html">
   Estimation of time variability in a lightcurve
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="light_curve.html">
   Light curves
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="light_curve_flare.html">
   Light curves for flares
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="light_curve_simulation.html">
   Simulating and fitting a time varying source
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Pulsar analysis
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../api/astro_dark_matter.html">
   Dark matter spatial and spectral models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/catalog.html">
   Source catalogs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/datasets.html">
   Datasets - Reduced data, IRFs, models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/fitting.html">
   Fitting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/makers.html">
   Makers - Data reduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/maps.html">
   Maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/mask_maps.html">
   Mask maps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/model_management.html">
   Modelling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/models.html">
   Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../api/observation_clustering.html">
   Observational clustering
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../scripts/survey_map.html">
   Survey Map Script
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Pulsar analysis
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#opening-the-data">
   Opening the data
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#check-setup">
   Check setup
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#phasogram">
   Phasogram
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#make-a-li-ma-test-over-the-events">
   Make a Li&amp;Ma test over the events
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#phase-resolved-map">
   Phase-resolved map
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#phase-resolved-spectrum">
   Phase-resolved spectrum
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-tutorials-analysis-time-pulsar-analysis-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code or to run this example in your browser via Binder</p>
</div>
<section class="sphx-glr-example-title" id="pulsar-analysis">
<span id="sphx-glr-tutorials-analysis-time-pulsar-analysis-py"></span><h1>Pulsar analysis<a class="headerlink" href="#pulsar-analysis" title="Permalink to this headline">#</a></h1>
<p>Produce a phasogram, phased-resolved maps and spectra for pulsar analysis.</p>
</section>
<section id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h1>
<p>This notebook shows how to do a simple pulsar analysis with Gammapy. We will produce a
phasogram, a phase-resolved map and a phase-resolved spectrum of the Vela pulsar. In
order to build these products, we will use the
<code class="xref py py-obj docutils literal notranslate"><span class="pre">PhaseBackgroundMaker</span></code> which takes into account the on and off phase to compute a
<code class="xref py py-obj docutils literal notranslate"><span class="pre">MapDatasetOnOff</span></code> and a <code class="xref py py-obj docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code> in the phase space.</p>
<p>This tutorial uses a simulated run of vel observation from the CTA DC1, which already contains a
column for the pulsar phases. The phasing in itself is therefore not show here. It
requires specific packages like Tempo2 or <a class="reference external" href="https://nanograv-pint.readthedocs.io">(PINT)</a>. A gammapy
recipe shows how to compute phases with PINT in the framework of Gammapy.</p>
</section>
<section id="opening-the-data">
<h1>Opening the data<a class="headerlink" href="#opening-the-data" title="Permalink to this headline">#</a></h1>
<p>Let’s first do the imports and load the only observation containing Vela
in the CTA 1DC dataset shipped with Gammapy.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove warnings</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># %matplotlib inline</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">DataStore</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="n">Datasets</span><span class="p">,</span> <span class="n">FluxPointsDataset</span><span class="p">,</span> <span class="n">MapDataset</span><span class="p">,</span> <span class="n">SpectrumDataset</span>
<span class="kn">from</span> <span class="nn">gammapy.estimators</span> <span class="kn">import</span> <span class="n">ExcessMapEstimator</span><span class="p">,</span> <span class="n">FluxPointsEstimator</span>
<span class="kn">from</span> <span class="nn">gammapy.makers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MapDatasetMaker</span><span class="p">,</span>
    <span class="n">PhaseBackgroundMaker</span><span class="p">,</span>
    <span class="n">SafeMaskMaker</span><span class="p">,</span>
    <span class="n">SpectrumDatasetMaker</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">MapAxis</span><span class="p">,</span> <span class="n">RegionGeom</span><span class="p">,</span> <span class="n">WcsGeom</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling</span> <span class="kn">import</span> <span class="n">Fit</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">PowerLawSpectralModel</span><span class="p">,</span> <span class="n">SkyModel</span>
<span class="kn">from</span> <span class="nn">gammapy.stats</span> <span class="kn">import</span> <span class="n">WStatCountsStatistic</span>
<span class="kn">from</span> <span class="nn">gammapy.utils.regions</span> <span class="kn">import</span> <span class="n">SphericalCircleSkyRegion</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="check-setup">
<h1>Check setup<a class="headerlink" href="#check-setup" title="Permalink to this headline">#</a></h1>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gammapy.utils.check</span> <span class="kn">import</span> <span class="n">check_tutorials_setup</span>

<span class="n">check_tutorials_setup</span><span class="p">()</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>System:

        python_executable      : /home/feijen/Documents/github/gammapy/.tox/build_docs/bin/python
        python_version         : 3.9.18
        machine                : x86_64
        system                 : Linux


Gammapy package:

        version                : 1.2.dev1721+g6c725d50c
        path                   : /home/feijen/Documents/github/gammapy/.tox/build_docs/lib/python3.9/site-packages/gammapy


Other packages:

        numpy                  : 1.26.3
        scipy                  : 1.12.0
        astropy                : 5.2.2
        regions                : 0.8
        click                  : 8.1.7
        yaml                   : 6.0.1
        IPython                : 8.18.1
        jupyterlab             : not installed
        matplotlib             : 3.8.2
        pandas                 : not installed
        healpy                 : 1.16.6
        iminuit                : 2.24.0
        sherpa                 : 4.16.0
        naima                  : 0.10.0
        emcee                  : 3.1.4
        corner                 : 2.2.2
        ray                    : 2.9.1


Gammapy environment variables:

        GAMMAPY_DATA           : /home/feijen/gammapy-datasets/dev
</pre></div>
</div>
<p>Load the data store (which is a subset of CTA-DC1 data):</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_store</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s2">&quot;$GAMMAPY_DATA/cta-1dc/index/gps&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Define observation ID and print events:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">id_obs_vela</span> <span class="o">=</span> <span class="p">[</span><span class="mi">111630</span><span class="p">]</span>
<span class="n">obs_list_vela</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">get_observations</span><span class="p">(</span><span class="n">id_obs_vela</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">obs_list_vela</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>EventList
---------

  Instrument       : None
  Telescope        : CTA
  Obs. ID          : 111630

  Number of events : 101430
  Event rate       : 56.350 1 / s

  Time start       : 59300.833333333336
  Time stop        : 59300.854166666664

  Min. energy      : 3.00e-02 TeV
  Max. energy      : 1.52e+02 TeV
  Median energy    : 1.00e-01 TeV

  Max. offset      : 5.0 deg
</pre></div>
</div>
<p>Now that we have our observation, let’s select the events in 0.2° radius
around the pulsar position.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">pos_target</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="mf">128.836</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=-</span><span class="mf">45.176</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>
<span class="n">on_radius</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">on_region</span> <span class="o">=</span> <span class="n">SphericalCircleSkyRegion</span><span class="p">(</span><span class="n">pos_target</span><span class="p">,</span> <span class="n">on_radius</span><span class="p">)</span>

<span class="c1"># Apply angular selection</span>
<span class="n">events_vela</span> <span class="o">=</span> <span class="n">obs_list_vela</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">select_region</span><span class="p">(</span><span class="n">on_region</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">events_vela</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>EventList
---------

  Instrument       : None
  Telescope        : CTA
  Obs. ID          : 111630

  Number of events : 843
  Event rate       : 0.468 1 / s

  Time start       : 59300.833333333336
  Time stop        : 59300.854166666664

  Min. energy      : 3.00e-02 TeV
  Max. energy      : 4.33e+01 TeV
  Median energy    : 1.07e-01 TeV

  Max. offset      : 1.7 deg
</pre></div>
</div>
<p>Let’s load the phases of the selected events in a dedicated array.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">phases</span> <span class="o">=</span> <span class="n">events_vela</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;PHASE&quot;</span><span class="p">]</span>

<span class="c1"># Let&#39;s take a look at the first 10 phases</span>
<span class="n">display</span><span class="p">(</span><span class="n">phases</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>   PHASE
-----------
 0.81847286
 0.45646095
0.111507416
 0.43416595
 0.76837444
  0.3639946
 0.58693695
 0.51095676
  0.5606985
  0.2505703
</pre></div>
</div>
</section>
<section id="phasogram">
<h1>Phasogram<a class="headerlink" href="#phasogram" title="Permalink to this headline">#</a></h1>
<p>Once we have the phases, we can make a phasogram. A phasogram is a
histogram of phases. It works exactly like any other histogram (you
can set the binning, evaluate the errors based on the counts in each
bin, etc).</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">nbins</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">phase_min</span><span class="p">,</span> <span class="n">phase_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">values</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">phase_min</span><span class="p">,</span> <span class="n">phase_max</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">)</span>
<span class="n">bin_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase_max</span> <span class="o">-</span> <span class="n">phase_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">nbins</span>

<span class="n">bin_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

<span class="c1"># Poissonian uncertainty on each bin</span>
<span class="n">values_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">bin_center</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">yerr</span><span class="o">=</span><span class="n">values_err</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Counts&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phasogram with angular cut of </span><span class="si">{</span><span class="n">on_radius</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">on_phase_range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
<span class="n">off_phase_range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_pulsar_analysis_001.png" srcset="../../_images/sphx_glr_pulsar_analysis_001.png" alt="Phasogram with angular cut of 0.2 deg" class = "sphx-glr-single-img"/><p>Now let’s add some fancy additions to our phasogram: a patch on the ON-
and OFF-phase regions and one for the background level.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Evaluate background level</span>
<span class="n">mask_off</span> <span class="o">=</span> <span class="p">(</span><span class="n">off_phase_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">phases</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">phases</span> <span class="o">&lt;</span> <span class="n">off_phase_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">count_bkg</span> <span class="o">=</span> <span class="n">mask_off</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of Off events: </span><span class="si">{</span><span class="n">count_bkg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># bkg level normalized by the size of the OFF zone (0.3)</span>
<span class="n">bkg</span> <span class="o">=</span> <span class="n">count_bkg</span> <span class="o">/</span> <span class="n">nbins</span> <span class="o">/</span> <span class="p">(</span><span class="n">off_phase_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">off_phase_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># error on the background estimation</span>
<span class="n">bkg_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">count_bkg</span><span class="p">)</span> <span class="o">/</span> <span class="n">nbins</span> <span class="o">/</span> <span class="p">(</span><span class="n">off_phase_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">off_phase_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Number of Off events: 234
</pre></div>
</div>
<p>Let’s redo the same plot for the basis</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">bin_center</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">yerr</span><span class="o">=</span><span class="n">values_err</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Plot background level</span>
<span class="n">x_bkg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_bkg</span><span class="p">,</span> <span class="p">(</span><span class="n">bkg</span> <span class="o">-</span> <span class="n">bkg_err</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_bkg</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_bkg</span><span class="p">,</span> <span class="p">(</span><span class="n">bkg</span> <span class="o">+</span> <span class="n">bkg_err</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_bkg</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">x_bkg</span><span class="p">,</span> <span class="n">bkg</span> <span class="o">-</span> <span class="n">bkg_err</span><span class="p">,</span> <span class="n">bkg</span> <span class="o">+</span> <span class="n">bkg_err</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>  <span class="c1"># grey area for the background level</span>

<span class="c1"># Let&#39;s make patches for the on and off phase zones</span>
<span class="n">on_patch</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
    <span class="n">on_phase_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">on_phase_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
<span class="p">)</span>

<span class="n">off_patch</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span>
    <span class="n">off_phase_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">off_phase_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">hatch</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
    <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Legends &quot;ON&quot; and &quot;OFF&quot;</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.55</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;ON&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.895</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;OFF&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Counts&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phasogram with angular cut of </span><span class="si">{</span><span class="n">on_radius</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_pulsar_analysis_002.png" srcset="../../_images/sphx_glr_pulsar_analysis_002.png" alt="Phasogram with angular cut of 0.2 deg" class = "sphx-glr-single-img"/></section>
<section id="make-a-li-ma-test-over-the-events">
<h1>Make a Li&amp;Ma test over the events<a class="headerlink" href="#make-a-li-ma-test-over-the-events" title="Permalink to this headline">#</a></h1>
<p>Another thing that we want to do is to compute a Li&amp;Ma test between the on-phase and the off-phase.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the ratio between the on-phase and the off-phase</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">on_phase_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">on_phase_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
    <span class="n">off_phase_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">off_phase_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Select events in the on region</span>
<span class="n">region_events</span> <span class="o">=</span> <span class="n">obs_list_vela</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">select_region</span><span class="p">(</span><span class="n">on_region</span><span class="p">)</span>

<span class="c1"># Select events in phase space</span>
<span class="n">on_events</span> <span class="o">=</span> <span class="n">region_events</span><span class="o">.</span><span class="n">select_parameter</span><span class="p">(</span><span class="s2">&quot;PHASE&quot;</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">on_phase_range</span><span class="p">)</span>
<span class="n">off_events</span> <span class="o">=</span> <span class="n">region_events</span><span class="o">.</span><span class="n">select_parameter</span><span class="p">(</span><span class="s2">&quot;PHASE&quot;</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">off_phase_range</span><span class="p">)</span>

<span class="c1"># Apply the WStat (Li&amp;Ma statistic)</span>
<span class="n">pulse_stat</span> <span class="o">=</span> <span class="n">WStatCountsStatistic</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">on_events</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">off_events</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of excess counts: </span><span class="si">{</span><span class="n">pulse_stat</span><span class="o">.</span><span class="n">n_sig</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TS: </span><span class="si">{</span><span class="n">pulse_stat</span><span class="o">.</span><span class="n">ts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significance: </span><span class="si">{</span><span class="n">pulse_stat</span><span class="o">.</span><span class="n">sqrt_ts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Number of excess counts: 44.00000000000003
TS: 15.211770556360534
Significance: 3.9002269877996247
</pre></div>
</div>
</section>
<section id="phase-resolved-map">
<h1>Phase-resolved map<a class="headerlink" href="#phase-resolved-map" title="Permalink to this headline">#</a></h1>
<p>Now that we have an overview of the phasogram of the pulsar, we can do a phase-resolved sky map
: a map of the ON-phase events minus alpha times the OFF-phase events.
Alpha is the ratio between the size of the ON-phase zone (here 0.1) and
the OFF-phase zone (0.3).</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">e_true</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span>
    <span class="mf">0.003</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">per_decade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy_true&quot;</span>
<span class="p">)</span>
<span class="n">e_reco</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span>
    <span class="mf">0.01</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">per_decade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span>
<span class="p">)</span>

<span class="n">geom</span> <span class="o">=</span> <span class="n">WcsGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">binsz</span><span class="o">=</span><span class="mf">0.02</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">skydir</span><span class="o">=</span><span class="n">pos_target</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;4 deg&quot;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">e_reco</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Let’s create an ON-map and an OFF-map:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">map_dataset_empty</span> <span class="o">=</span> <span class="n">MapDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="n">energy_axis_true</span><span class="o">=</span><span class="n">e_true</span><span class="p">)</span>

<span class="n">map_dataset_maker</span> <span class="o">=</span> <span class="n">MapDatasetMaker</span><span class="p">()</span>
<span class="n">phase_bkg_maker</span> <span class="o">=</span> <span class="n">PhaseBackgroundMaker</span><span class="p">(</span>
    <span class="n">on_phase</span><span class="o">=</span><span class="n">on_phase_range</span><span class="p">,</span> <span class="n">off_phase</span><span class="o">=</span><span class="n">off_phase_range</span><span class="p">,</span> <span class="n">phase_column_name</span><span class="o">=</span><span class="s2">&quot;PHASE&quot;</span>
<span class="p">)</span>

<span class="n">offset_max</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">safe_mask_maker</span> <span class="o">=</span> <span class="n">SafeMaskMaker</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;offset-max&quot;</span><span class="p">],</span> <span class="n">offset_max</span><span class="o">=</span><span class="n">offset_max</span><span class="p">)</span>

<span class="n">map_datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">()</span>

<span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_list_vela</span><span class="p">:</span>
    <span class="n">map_dataset</span> <span class="o">=</span> <span class="n">map_dataset_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">map_dataset_empty</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">map_dataset</span> <span class="o">=</span> <span class="n">safe_mask_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">map_dataset</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">map_dataset_on_off</span> <span class="o">=</span> <span class="n">phase_bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">map_dataset</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">map_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">map_dataset_on_off</span><span class="p">)</span>
</pre></div>
</div>
<p>Once the data reduction is done, we can plot the map of the counts-ON (i.e. in the ON-phase)
and the map of the background (i.e. the counts-OFF, selected in the OFF-phase, multiplied by alpha).
If one wants to plot the counts-OFF instead, <code class="xref py py-obj docutils literal notranslate"><span class="pre">background</span></code> should be replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">counts_off</span></code> in the following cell.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">counts</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">map_datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">sum_over_axes</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">background</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">map_datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">sum_over_axes</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wcs</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">add_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Counts&quot;</span><span class="p">)</span>

<span class="n">background</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">add_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Background&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_pulsar_analysis_003.png" srcset="../../_images/sphx_glr_pulsar_analysis_003.png" alt="Counts, Background" class = "sphx-glr-single-img"/><p>Finally, we can run an <a class="reference internal" href="../../api/gammapy.estimators.ExcessMapEstimator.html#gammapy.estimators.ExcessMapEstimator" title="gammapy.estimators.ExcessMapEstimator"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ExcessMapEstimator</span></code></a> to compute the excess and significance maps.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">excess_map_estimator</span> <span class="o">=</span> <span class="n">ExcessMapEstimator</span><span class="p">(</span>
    <span class="n">correlation_radius</span><span class="o">=</span><span class="s2">&quot;0.2 deg&quot;</span><span class="p">,</span> <span class="n">energy_edges</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">estimator_results</span> <span class="o">=</span> <span class="n">excess_map_estimator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">map_datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">npred_excess</span> <span class="o">=</span> <span class="n">estimator_results</span><span class="o">.</span><span class="n">npred_excess</span>
<span class="n">sqrt_ts</span> <span class="o">=</span> <span class="n">estimator_results</span><span class="o">.</span><span class="n">sqrt_ts</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">npred_excess</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">wcs</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">npred_excess</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">add_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Excess counts&quot;</span><span class="p">)</span>

<span class="n">sqrt_ts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">add_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Significance&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_pulsar_analysis_004.png" srcset="../../_images/sphx_glr_pulsar_analysis_004.png" alt="Excess counts, Significance" class = "sphx-glr-single-img"/><p>Note that here we are lacking statistic because we only use one run of CTA.</p>
</section>
<section id="phase-resolved-spectrum">
<h1>Phase-resolved spectrum<a class="headerlink" href="#phase-resolved-spectrum" title="Permalink to this headline">#</a></h1>
<p>We can also make a phase-resolved spectrum.
In order to do that, we are going to use the <a class="reference internal" href="../../api/gammapy.makers.PhaseBackgroundMaker.html#gammapy.makers.PhaseBackgroundMaker" title="gammapy.makers.PhaseBackgroundMaker"><code class="xref py py-obj docutils literal notranslate"><span class="pre">PhaseBackgroundMaker</span></code></a> to create a
<code class="xref py py-obj docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code> with the ON and OFF taken in the phase space.
Note that this maker take the ON and OFF in the same spatial region.</p>
<p>Here to create the <a class="reference internal" href="../../api/gammapy.datasets.SpectrumDatasetOnOff.html#gammapy.datasets.SpectrumDatasetOnOff" title="gammapy.datasets.SpectrumDatasetOnOff"><code class="xref py py-obj docutils literal notranslate"><span class="pre">SpectrumDatasetOnOff</span></code></a>, we are going to redo the whole data reduction.
However, note that one can use the <code class="xref py py-obj docutils literal notranslate"><span class="pre">to_spectrum_dataset()</span></code> method of <a class="reference internal" href="../../api/gammapy.datasets.MapDatasetOnOff.html#gammapy.datasets.MapDatasetOnOff" title="gammapy.datasets.MapDatasetOnOff"><code class="xref py py-obj docutils literal notranslate"><span class="pre">MapDatasetOnOff</span></code></a>
(with the <code class="xref py py-obj docutils literal notranslate"><span class="pre">containment_correction</span></code> parameter set to True) if such a <a class="reference internal" href="../../api/gammapy.datasets.MapDatasetOnOff.html#gammapy.datasets.MapDatasetOnOff" title="gammapy.datasets.MapDatasetOnOff"><code class="xref py py-obj docutils literal notranslate"><span class="pre">MapDatasetOnOff</span></code></a>
has been created as shown above.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">e_true</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span><span class="mf">0.003</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy_true&quot;</span><span class="p">)</span>
<span class="n">e_reco</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">)</span>


<span class="n">geom</span> <span class="o">=</span> <span class="n">RegionGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">e_reco</span><span class="p">])</span>

<span class="n">spectrum_dataset_empty</span> <span class="o">=</span> <span class="n">SpectrumDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="n">energy_axis_true</span><span class="o">=</span><span class="n">e_true</span><span class="p">)</span>

<span class="n">spectrum_dataset_maker</span> <span class="o">=</span> <span class="n">SpectrumDatasetMaker</span><span class="p">()</span>
<span class="n">phase_bkg_maker</span> <span class="o">=</span> <span class="n">PhaseBackgroundMaker</span><span class="p">(</span>
    <span class="n">on_phase</span><span class="o">=</span><span class="n">on_phase_range</span><span class="p">,</span> <span class="n">off_phase</span><span class="o">=</span><span class="n">off_phase_range</span><span class="p">,</span> <span class="n">phase_column_name</span><span class="o">=</span><span class="s2">&quot;PHASE&quot;</span>
<span class="p">)</span>

<span class="n">offset_max</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
<span class="n">safe_mask_maker</span> <span class="o">=</span> <span class="n">SafeMaskMaker</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;offset-max&quot;</span><span class="p">],</span> <span class="n">offset_max</span><span class="o">=</span><span class="n">offset_max</span><span class="p">)</span>

<span class="n">spectrum_datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">()</span>

<span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">obs_list_vela</span><span class="p">:</span>
    <span class="n">spectrum_dataset</span> <span class="o">=</span> <span class="n">spectrum_dataset_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">spectrum_dataset_empty</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">spectrum_dataset</span> <span class="o">=</span> <span class="n">safe_mask_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">spectrum_dataset</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">spectrum_dataset_on_off</span> <span class="o">=</span> <span class="n">phase_bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">spectrum_dataset</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>
    <span class="n">spectrum_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectrum_dataset_on_off</span><span class="p">)</span>
</pre></div>
</div>
<p>Now let’s take a look at the datasets we just created:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum_datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_pulsar_analysis_005.png" srcset="../../_images/sphx_glr_pulsar_analysis_005.png" alt="Counts, Exposure, Energy Dispersion" class = "sphx-glr-single-img"/><p>Now we’ll fit a model to the spectrum with the <a class="reference internal" href="../../api/gammapy.modeling.Fit.html#gammapy.modeling.Fit" title="gammapy.modeling.Fit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Fit</span></code></a> class. First we
load a power law model with an initial value for the index and the
amplitude and then wo do a likelihood fit. The fit results are printed
below.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectral_model</span> <span class="o">=</span> <span class="n">PowerLawSpectralModel</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="s2">&quot;1.3e-9 cm-2 s-1 TeV-1&quot;</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;0.02 TeV&quot;</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spectral_model</span><span class="o">=</span><span class="n">spectral_model</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;vela psr&quot;</span><span class="p">)</span>
<span class="n">emin_fit</span><span class="p">,</span> <span class="n">emax_fit</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.04</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">)</span>

<span class="n">mask_fit</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">energy_mask</span><span class="p">(</span><span class="n">energy_min</span><span class="o">=</span><span class="n">emin_fit</span><span class="p">,</span> <span class="n">energy_max</span><span class="o">=</span><span class="n">emax_fit</span><span class="p">)</span>

<span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">spectrum_datasets</span><span class="p">:</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">model</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">mask_fit</span> <span class="o">=</span> <span class="n">mask_fit</span>

<span class="n">joint_fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">()</span>
<span class="n">joint_result</span> <span class="o">=</span> <span class="n">joint_fit</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">spectrum_datasets</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">joint_result</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>OptimizeResult

        backend    : minuit
        method     : migrad
        success    : True
        message    : Optimization terminated successfully.
        nfev       : 101
        total stat : 7.07

CovarianceResult

        backend    : minuit
        method     : hesse
        success    : True
        message    : Hesse terminated successfully.
</pre></div>
</div>
<p>Now you might want to do the stacking here even if in our case there is
only one observation which makes it superfluous. We can compute flux
points by fitting the norm of the global model in energy bands.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">energy_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.04</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.4</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>

<span class="n">stack_dataset</span> <span class="o">=</span> <span class="n">spectrum_datasets</span><span class="o">.</span><span class="n">stack_reduce</span><span class="p">()</span>

<span class="n">stack_dataset</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">model</span>

<span class="n">fpe</span> <span class="o">=</span> <span class="n">FluxPointsEstimator</span><span class="p">(</span>
    <span class="n">energy_edges</span><span class="o">=</span><span class="n">energy_edges</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;vela psr&quot;</span><span class="p">,</span> <span class="n">selection_optional</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
<span class="p">)</span>

<span class="n">flux_points</span> <span class="o">=</span> <span class="n">fpe</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="p">[</span><span class="n">stack_dataset</span><span class="p">])</span>
<span class="n">flux_points</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;ts_threshold_ul&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">amplitude_ref</span> <span class="o">=</span> <span class="mf">0.57</span> <span class="o">*</span> <span class="mf">19.4e-14</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;1 / (cm2 s MeV)&quot;</span><span class="p">)</span>
<span class="n">spec_model_true</span> <span class="o">=</span> <span class="n">PowerLawSpectralModel</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude_ref</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;20 GeV&quot;</span>
<span class="p">)</span>

<span class="n">flux_points_dataset</span> <span class="o">=</span> <span class="n">FluxPointsDataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">flux_points</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can plot.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax_spectrum</span><span class="p">,</span> <span class="n">ax_residuals</span> <span class="o">=</span> <span class="n">flux_points_dataset</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">()</span>

<span class="n">ax_spectrum</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">1e-14</span><span class="p">,</span> <span class="mf">3e-11</span><span class="p">])</span>
<span class="n">ax_residuals</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">])</span>

<span class="n">spec_model_true</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax_spectrum</span><span class="p">,</span>
    <span class="n">energy_bounds</span><span class="o">=</span><span class="p">(</span><span class="n">emin_fit</span><span class="p">,</span> <span class="n">emax_fit</span><span class="p">),</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reference model&quot;</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span>
    <span class="n">energy_power</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax_spectrum</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_pulsar_analysis_006.png" srcset="../../_images/sphx_glr_pulsar_analysis_006.png" alt="pulsar analysis" class = "sphx-glr-single-img"/><p>This tutorial suffers a bit from the lack of statistics: there were 9
Vela observations in the CTA DC1 while there is only one here. When done
on the 9 observations, the spectral analysis is much better agreement
between the input model and the gammapy fit.</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-tutorials-analysis-time-pulsar-analysis-py">
<div class="binder-badge docutils container">
<a class="reference external image-reference" href="https://mybinder.org/v2/gh/gammapy/gammapy-webpage/master?urlpath=lab/tree/notebooks/dev/tutorials/analysis-time/pulsar_analysis.ipynb"><img alt="Launch binder" src="../../_images/binder_badge_logo3.svg" width="150px" /></a>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/711c78a1a60c4f304b61eca7c205cd02/pulsar_analysis.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">pulsar_analysis.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/ec6ec35ddc2c98b82ef77dc71701733a/pulsar_analysis.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">pulsar_analysis.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>


              </div>
              
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2024, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>